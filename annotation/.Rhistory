ordiellipse(example_NMDS,groups=treat,label=T)
example_NMDS=metaMDS(all_bgc_s, # Our community-by-species matrix
k=4) # The number of reduced dimensions
plot(example_NMDS)
ordiplot(example_NMDS, type="n")
stressplot(example_NMDS)
plot(example_NMDS)
ordiplot(example_NMDS, type="n")
orditorp(example_NMDS,display="species",col="red",air=0.01)
orditorp(example_NMDS,display="sites",cex=1.25,air=0.01)
treat = replace_na(annotation_row[,'Agriculture'], replace = 'Outgroup') ## corresponds to rows/communities (genomes)
## ellipse
ordiplot(example_NMDS,type="n")
#ordiplot(example_NMDS,type="n")
ordiellipse(example_NMDS,groups=treat,label=T)
example_NMDS=metaMDS(all_bgc_s, # Our community-by-species matrix
k=2) # The number of reduced dimensions
stressplot(example_NMDS)
plot(example_NMDS)
ordiplot(example_NMDS, type="n")
orditorp(example_NMDS,display="species",col="red",air=0.01)
orditorp(example_NMDS,display="sites",cex=1.25,air=0.01)
treat = replace_na(annotation_row[,'Agriculture'], replace = 'Outgroup') ## corresponds to rows/communities (genomes)
## ellipse
ordiplot(example_NMDS,type="n")
#ordiplot(example_NMDS,type="n")
ordiellipse(example_NMDS,groups=treat,label=T)
stressplot(example_NMDS)
example_NMDS=metaMDS(all_bgc_s, # Our community-by-species matrix
k=3) # The number of reduced dimensions
stressplot(example_NMDS)
example_NMDS=metaMDS(all_bgc_s, # Our community-by-species matrix
k=4) # The number of reduced dimensions
stressplot(example_NMDS)
head(proportion)
treat = replace_na(annotation_row[,'Agriculture'], replace = 'Outgroup') ## corresponds to rows/communities (genomes)
## ellipse
ordiplot(example_NMDS,type="n")
#ordiplot(example_NMDS,type="n")
ordiellipse(example_NMDS,groups=treat,label=T)
?metaMDS
?stressplot
?screeplot()
source('~/GoogleDriveLab/Figures/EscoEvoGenomics/bigscape_component_analysis.R', echo=TRUE)
## look at this
#head(pca_data$x)
screeplot(pca_data)
## PCA
pca_data <- prcomp(all_bgc_s)
eigs <- pca_data$sdev^2
proportion = (eigs/sum(eigs))*100
head(proportion)
cumulative = cumsum(eigs)/sum(eigs)
## look at this
#head(pca_data$x)
screeplot(pca_data)
library(tidyverse)
library(pheatmap)
munge_gca <- function(x){
paste(strsplit(x, split = "_")[[1]][c(1,2)], collapse = "_")
}
#
# get_cluster <- function(x){
#   spliter = strsplit(x, split = "/")[[1]][c(4, 5)]
#   cluster_list <- strsplit(spliter[2], split = "\\.")[[1]]
#   cluster = cluster_list[which(grepl('cluster', cluster_list))]
#   paste0(spliter[1], ":", cluster)
# }
metadata <- read_csv('metadata.csv')
meta_levels <- metadata$genus_species
## dive in deeper to presence absence output
ant_ag <- na.omit(unique(metadata$Agriculture))
files <- list.files("parsed_networks", pattern = 'network', recursive = TRUE, full.names = TRUE)
all_data <- lapply(files, function(x){
table <- read_tsv(x, col_names = c('component', 'bigscape')) %>%
mutate(BGC_type = sub("_.*$", "", basename(x)))
}) %>% bind_rows() %>%
group_by(bigscape) %>%
mutate(acc = ifelse(grepl('GCA', bigscape),
yes = munge_gca(bigscape),
no = ifelse(grepl('SPDT', bigscape),
yes = paste(strsplit(bigscape, split = "\\.")[[1]][c(1,2)], collapse = "."),
no = sub("_.*$", "", bigscape)))) %>%
ungroup() %>%
left_join(., metadata, by = 'acc') %>%
mutate(Presence = 1) %>%
group_by(component, BGC_type) %>%
mutate(num_agricultures = length(unique(na.omit(Agriculture)))) %>% ## removes outgroups from count
filter(!is.na(acc)) %>%
mutate(Agriculture = ifelse(is.na(Agriculture),
yes = 'Outgroup',
no = Agriculture)) %>%
ungroup() %>%
group_by(BGC_type, component) %>%
mutate(bgc_plot_label = ifelse(any(grepl('BGC', acc)),
yes = paste(grep('BGC', acc, value = TRUE), collapse = ","),
no = paste0(BGC_type, "_", component))) %>%
ungroup()
#View(select(all_data, component, Agriculture, bigscape, num_agricultures, BGC_type))
#unique(all_data$acc)
#all_data %>% filter(component == 'component_111', BGC_type == 'mix') %>% View()
## do all bgc first with 'mix' seperate
ann_colors = list(
'BGC_type' = c(NRPS = '#1B9E77', PKSI = '#D95F02', Terpene = '#7570B3', Others = "#E7298A", PKS.NRP = "#66A61E"),
'Agriculture' = c(Leafcutter = 'green4', Lower = 'yellow', Coral = 'magenta3', Higher = 'blue3', 'NA' = 'white')
)
all_bgc <- all_data %>%
filter(!BGC_type %in% c('PKSother', 'mix'),
num_agricultures > 0,
!grepl('BGC', acc)) %>% ## only look at BGC that are in at least 1 ant agriculture
select(bgc_plot_label, genus_species, Presence, BGC_type) %>%
mutate(bgc_plot_label = sub('-', '.', bgc_plot_label)) %>%
mutate(BGC_type = sub('-', '.', BGC_type))
#all_bgc %>% filter(component == 'component_111', BGC_type == 'mix') %>% View()
all_bgc_s <- all_bgc %>% select(-BGC_type) %>%
distinct() %>%
spread(bgc_plot_label, Presence) %>%
data.frame()
rownames(all_bgc_s) <- all_bgc_s$genus_species
all_bgc_s$genus_species <- NULL
all_bgc_s <- as.matrix(all_bgc_s)
all_bgc_s[is.na(all_bgc_s)] <- 0
rows_order <- meta_levels[which(meta_levels %in% rownames(all_bgc_s))]
m <- metadata %>% select(Agriculture, genus_species) %>% distinct() %>% data.frame()
rownames(m) <- m$genus_species
m$genus_species <- NULL
annotation_col <- all_bgc %>%
select(-genus_species, -Presence) %>%
filter(bgc_plot_label %in% colnames(all_bgc_s)) %>%
distinct() %>%
data.frame()
rownames(annotation_col) <- annotation_col$bgc_plot_label
annotation_col$bgc_plot_label <- NULL
annotation_row = data.frame(
"Agriculture" = m[rownames(all_bgc_s), ],
row.names = rownames(all_bgc_s),
stringsAsFactors = FALSE
)
pheatmap::pheatmap(all_bgc_s[rows_order,],
legend = FALSE,
color = c('grey87', 'black'),
cluster_rows = FALSE,
cluster_cols = TRUE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
annotation_row = annotation_row,
annotation_col = annotation_col,
annotation_colors = ann_colors,
main = "Components present in at least one ant agriculture",
filename = paste0('all_BGC_components.pdf'))
## PCA
pca_data <- prcomp(all_bgc_s)
eigs <- pca_data$sdev^2
proportion = (eigs/sum(eigs))*100
head(proportion)
cumulative = cumsum(eigs)/sum(eigs)
## look at this
#head(pca_data$x)
screeplot(pca_data)
## nmds
library(vegan)
## bray curtis distance is more resilient to nulls
example_NMDS=metaMDS(all_bgc_s, # Our community-by-species matrix
k=3) # The number of reduced dimensions
stressplot(example_NMDS)
treat = replace_na(annotation_row[,'Agriculture'], replace = 'Outgroup') ## corresponds to rows/communities (genomes)
## ellipse
ordiplot(example_NMDS,type="n")
#ordiplot(example_NMDS,type="n")
ordiellipse(example_NMDS,groups=treat,label=T)
## bray curtis distance is more resilient to nulls
example_NMDS=metaMDS(all_bgc_s, # Our community-by-species matrix
k=4) # The number of reduced dimensions
stressplot(example_NMDS)
treat = replace_na(annotation_row[,'Agriculture'], replace = 'Outgroup') ## corresponds to rows/communities (genomes)
## ellipse
ordiplot(example_NMDS,type="n")
#ordiplot(example_NMDS,type="n")
ordiellipse(example_NMDS,groups=treat,label=T)
screeplot(example_NMDS)
vegan::anosim()
?vegan::anosim()
anosim(all_bgc_s, grouping = treat)
bgc_dist <- vegdist(all_bgc_s)
anosim(bgc_dist, grouping = treat)
ano_test <- anosim(bgc_dist, grouping = treat)
summary(ano_test)
plot(ano_test)
anova(example_NMDS)
anova(bgc_dist)
anova(all_bgc_s, ~treat)
?anova
head(all_bgc_s)
?anosim
## ellipse
ordiplot(example_NMDS,type="n")
#ordiplot(example_NMDS,type="n")
ordiellipse(example_NMDS,groups=treat,label=T)
summary(ano_test)
ano_test$statistic
ano_test$signif
dune.env
data(dune)
data(dune.env)
dune
dune.env
?adonis2
adonis2(dune ~ Management*A1, data = dune.env)
head(annotation_col)
annotation_row)
annotation_row
head(dune)
head(dune.env)
lapply(dune.env, unique)
head(metadata)
head(metadata$Agriculture)
tail(metadata$Agriculture)
adonis2(all_bgc_s ~ Agriculture, data = metadata)
nrow(dune)
nrow(dune.env)
head(all_bgc_s)
nrow(all_bgc_s)
nrow(metadata)
rownames(metadata) <- metadata$genus_species
metadata <- metadata %>% data.frame(., stringsAsFactors = FALSE)
rownames(metadata) <- metadata$genus_species
adonis2(all_bgc_s ~ Agriculture, data = metadata)
?adonis2
data(dune.env)
head(dune.env)
nrow(dune.env)
nrow(dune)
dune
### Example of use with strata, for nested (e.g., block) designs.
dat <- expand.grid(rep=gl(2,1), NO3=factor(c(0,10)),field=gl(3,1) )
dat
Agropyron <- with(dat, as.numeric(field) + as.numeric(NO3)+2) +rnorm(12)/2
Schizachyrium <- with(dat, as.numeric(field) - as.numeric(NO3)+2) +rnorm(12)/2
total <- Agropyron + Schizachyrium
dotplot(total ~ NO3, dat, jitter.x=TRUE, groups=field,
type=c('p','a'), xlab="NO3", auto.key=list(columns=3, lines=TRUE) )
Y <- data.frame(Agropyron, Schizachyrium)
mod <- metaMDS(Y, trace = FALSE)
plot(mod)
### Ellipsoid hulls show treatment
with(dat, ordiellipse(mod, field, kind = "ehull", label = TRUE))
### Spider shows fields
with(dat, ordispider(mod, field, lty=3, col="red"))
### Incorrect (no strata)
perm <- how(nperm = 199)
adonis2 (Y ~ NO3, data = dat, permutations = perm)
data
head(data)
dat
head(all_bgc_s)
head(metadata)
adon_data <- cbind(all_bgc_s, metadata[rownames(all_bgc_s),])
head(adon_data)
adonis2(adon_data ~ Agriculture, data = metadata)
metadata <- metadata %>%
mutate(Agriculture = replace_na(replace = 'Outgroup')) %>% data.frame(., stringsAsFactors = FALSE)
metadata <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>% data.frame(., stringsAsFactors = FALSE)
rownames(metadata) <- metadata$genus_species
adon_data <- cbind(all_bgc_s, metadata[rownames(all_bgc_s),])
adonis2(adon_data ~ Agriculture, data = metadata)
metadata <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>% data.frame(., stringsAsFactors = FALSE) %>%
select(Agriculture)
rownames(metadata) <- metadata$genus_species
adon_data <- cbind(all_bgc_s, metadata[rownames(all_bgc_s),])
adonis2(adon_data ~ Agriculture, data = metadata)
adon_data
metadata <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture) %>%
data.frame(., stringsAsFactors = FALSE)
rownames(metadata) <- metadata$genus_species
adon_data <- cbind(all_bgc_s, metadata[rownames(all_bgc_s),])
adon_data
metadata <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture) %>%
data.frame(., stringsAsFactors = FALSE)
rownames(metadata) <- metadata$genus_species
adon_data <- cbind(all_bgc_s, metadata[rownames(all_bgc_s),])
adon_data
metadata <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture, genus_species) %>%
data.frame(., stringsAsFactors = FALSE)
rownames(metadata) <- metadata$genus_species
adon_data <- cbind(all_bgc_s, metadata[rownames(all_bgc_s),])
adon_data
metadata <- read_csv('metadata.csv')
metadata1 <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture, genus_species) %>%
data.frame(., stringsAsFactors = FALSE)
rownames(metadata1) <- metadata1$genus_species
adon_data <- cbind(all_bgc_s, metadata1[rownames(all_bgc_s),])
adonis2(adon_data ~ Agriculture, data = metadata)
adon_data
dat
metadata1 <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture, genus_species) %>%
data.frame(., stringsAsFactors = FALSE)
metadata1
metadata1 <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture, genus_species) %>%
mutate(ag_num = seq_along(Agriculture)) %>%
data.frame(., stringsAsFactors = FALSE)
metadata1
metadata1 <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture, genus_species) %>%
group_by(Agriculture) %>%
mutate(ag_num = seq_along(Agriculture)) %>%
data.frame(., stringsAsFactors = FALSE)
metadata1
metadata1 <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture, genus_species) %>%
group_by(Agriculture) %>%
mutate(ag_num = rank(Agriculture)) %>%
data.frame(., stringsAsFactors = FALSE)
metadata1
metadata1 <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture, genus_species) %>%
mutate(ag_num = rank(Agriculture)) %>%
data.frame(., stringsAsFactors = FALSE)
metadata1
?seq_along
rank_df <- data.frame(Agriculture = unique(metadata$Agriculture)
)
rank_df
rank_df <- data.frame(Agriculture = unique(metadata$Agriculture)) %>% mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup'))
rank_df <- data.frame(Agriculture = unique(metadata$Agriculture), stringsAsFactors = FALSE) %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup'))
rank_df
rank_df <- data.frame(Agriculture = unique(metadata$Agriculture), stringsAsFactors = FALSE) %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
mutate(ag_num = seq_along(Agriculture))
rank_df
metadata1 <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture, genus_species) %>%
left_join(., rank_df, by = 'Agriculture') %>%
data.frame(., stringsAsFactors = FALSE)
metadata1
metadata1
rownames(metadata1) <- metadata1$genus_species
metadata1 <- metadata %>%
mutate(Agriculture = replace_na(Agriculture, replace = 'Outgroup')) %>%
select(Agriculture, genus_species) %>%
left_join(., rank_df, by = 'Agriculture') %>%
select(-Agriculture) %>%
data.frame(., stringsAsFactors = FALSE)
metadata1
rownames(metadata1) <- metadata1$genus_species
metadata1$genus_species <- NULL
metadata1
adon_data <- cbind(all_bgc_s, metadata1[rownames(all_bgc_s),])
adonis2(adon_data ~ Agriculture, data = metadata)
adonis2(adon_data ~ ag_num, data = metadata1)
summary(adonis2(adon_data ~ ag_num, data = metadata1))
adonis <- adonis2(adon_data ~ ag_num, data = metadata1)
?adonis2
adon_data
adonis <- adonis2(adon_data ~ ag_num, data = adon_data)
adon_data <- cbind(all_bgc_s, metadata1[rownames(all_bgc_s),])
colnames(adon_data)
dat
head(all_bgc)
head(bgc_dist)
bgc_dist
bgc_dist <- vegdist(all_bgc_s)
summary(bgc_dist)
?anova
?lm
?aov
?anosim
bgc_dist <- vegdist(all_bgc_s)
ano_test <- anosim(bgc_dist, grouping = treat)
summary(ano_test)
plot(ano_test)
## bray curtis distance is more resilient to nulls
example_NMDS=metaMDS(all_bgc_s, # Our community-by-species matrix
k=4) # The number of reduced dimensions
stressplot(example_NMDS)
treat = replace_na(annotation_row[,'Agriculture'], replace = 'Outgroup') ## corresponds to rows/communities (genomes)
## ellipse
ordiplot(example_NMDS,type="n")
#ordiplot(example_NMDS,type="n")
ordiellipse(example_NMDS,groups=treat,label=T)
getwd()
source('~/scripts/theme_kirsten.R')
library(pheatmap)
library(RColorBrewer)
library(tidyverse)
library(ggfortify)
cazy_files <- list.files('cazy', full.names = TRUE)
cazy_files <- list.files('cazy', full.names = TRUE)
cazy_files <- list.files('cazy', full.names = TRUE)
cazy_files <- list.files('cazy', full.names = TRUE)
cazy_files <- list.files('cazy', full.names = TRUE)
cazy_files <- list.files('cazy', full.names = TRUE)
cazy_files
list.files()
setwd('annotation')
list.files()
cazy_files <- list.files('cazy', full.names = TRUE)
c <- cazy_files[1]
c
cazy <- lapply(cazy_files, function(c){
read_tsv(c) %>%
summarize(NumCazy = length(unique(`Gene ID`)))  %>%
mutate(genome = sub(".txt", "", basename(c)))
}) %>% bind_rows() %>% as.data.frame()
metadata <- read_csv('../metadata.csv') %>%
mutate(acc_red = sub("\\..*$", "", acc))
cazy$genome <- factor(cazy$genome, levels = rev(metadata$acc_red))
## cazy
cazy %>% ggplot(., aes(y = NumCazy, x = genome)) +
geom_col() +
theme_kirsten(rot = 90) + coord_flip() +
ggsave('cazy.pdf')
rownames(cazy) <- cazy$genome
metadata
metadata$genus_species
## cazy
cazy %>% ggplot(., aes(y = NumCazy, x = genus_species)) +
geom_col() +
theme_kirsten(rot = 90) + coord_flip() +
ggsave('cazy.pdf')
cazy %>% ggplot(., aes(y = NumCazy, x = genus_species)) +
geom_col() +
theme_kirsten(rot = 90) + coord_flip()
head(cazy)
head(metadata)
fam_db <- read_tsv('CAZyDB.07312018.fam-activities.txt', comment = '#', col_names = c('cazy_base', 'cazy_description'))
fam_db
cazy <- lapply(cazy_files, function(c){
read_tsv(c) %>%
mutate(genome = sub(".txt", "", basename(c)))
}) %>% bind_rows() %>%
separate(HMMER, into = c('hmmer', 'startstop'), sep = "\\(", remove = FALSE) %>%
separate(startstop, into = c('start', 'stop'), sep = '-') %>%
mutate(stop = sub("\\)", "", stop)) %>%
mutate(HMMER = gsub('\\([0-9-]+\\)', "", HMMER)) %>%
select(-hmmer) %>%
rename(gene = `Gene ID`) %>%
gather(tool, cazy_id, -gene, -start, -stop, -`#ofTools`, -genome) %>%
group_by(gene) %>%
mutate(cazy_ids = paste(unique(cazy_id), collapse = ",")) %>%
select(-tool, -cazy_id, -`#ofTools`) %>%
unnest(cazy_id = strsplit(cazy_ids, ",")) %>%
unnest(cazy = strsplit(cazy_id, "\\+")) %>%
select(gene, start, stop, genome, cazy) %>%
distinct() %>%
mutate(cazy_base = sub("_.*$", "", cazy)) %>%
left_join(., fam_db, by = 'cazy_base') %>%
filter(cazy != 'N') %>%
group_by(genome, cazy_base) %>%
mutate(n_genes = as.numeric(length(unique(gene))))
head(cazy)
all_bgc <- all_data %>%
filter(BGC_type %in% c('mix'),
num_agricultures > 0,
!grepl('BGC', acc)) %>% ## only look at BGC that are in at least 1 ant agriculture
select(bgc_plot_label, genus_species, Presence, BGC_type) %>%
mutate(bgc_plot_label = sub('-', '.', bgc_plot_label))
all_bgc_s <- all_bgc %>% select(-BGC_type) %>%
distinct() %>%
spread(bgc_plot_label, Presence) %>%
data.frame()
rownames(all_bgc_s) <- all_bgc_s$genus_species
all_bgc_s$genus_species <- NULL
all_bgc_s <- as.matrix(all_bgc_s)
all_bgc_s[is.na(all_bgc_s)] <- 0
rows_order <- meta_levels[which(meta_levels %in% rownames(all_bgc_s))]
m <- metadata %>% select(Agriculture, genus_species) %>% distinct() %>% data.frame()
rownames(m) <- m$genus_species
m$genus_species <- NULL
annotation_row = data.frame(
"Agriculture" = m[rownames(all_bgc_s), ],
row.names = rownames(all_bgc_s)
)
pheatmap::pheatmap(all_bgc_s[rows_order,],
legend = FALSE,
color = c('grey87', 'black'),
cluster_rows = FALSE,
cluster_cols = TRUE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
annotation_row = annotation_row,
annotation_colors = ann_colors,
main = "Mixed components present in at least one ant agriculture",
filename = paste0('all_BGC_components_mix.pdf'))
pca_data <- prcomp(all_bgc_s)
eigs <- pca_data$sdev^2
proportion = (eigs/sum(eigs))*100
head(proportion)
cumulative = cumsum(eigs)/sum(eigs)
## look at this
#head(pca_data$x)
screeplot(pca_data)
