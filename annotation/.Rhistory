knitr::opts_chunk$set(echo = FALSE, warning = FALSE, results = FALSE, message = FALSE)
library('tidyverse')
source('~/scripts/theme_kirsten.R')
# Chunk 1: setup
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, results = FALSE, message = FALSE)
library('tidyverse')
source('~/scripts/theme_kirsten.R')
find_seq_error <- function(vector){
n <- vector[1]
for(y in vector){
if(y <= n){
n = y
} else {
reverse = y
return(reverse)
break
}
}
}
icbg_lookup <- read_tsv('data/icbg_lookup.tsv')
test <- c(1, 100)
library(tidyverse)
df <- data.frame(
x = rep(c(2, 5, 7, 9, 12), 2),
y = rep(c(1, 2), each = 5),
z = factor(rep(1:5, each = 2)),
w = rep(diff(c(0, 4, 6, 8, 10, 14)), 2)
)
df
ggplot(df, aes(x, y)) +
geom_tile(aes(fill = z), colour = "grey50")
ggplot(df, aes(xmin = x - w / 2, xmax = x + w / 2, ymin = y, ymax = y + 1)) +
geom_rect(aes(fill = z), colour = "grey50")
df <- data.frame(
s = c(5, 15, 30),
e = c(10, 25, 40),
y = c(1, 2, 3)
)
df
ggplot(df, aes(xmin = s, xmax = e, ymin = y - 0.5, ymax = y + 0.5)) +
geom_rect(aes(fill = z), colour = "grey50")
ggplot(df, aes(xmin = s, xmax = e, ymin = y - 0.5, ymax = y + 0.5)) +
geom_rect(aes(), colour = "grey50")
df <- data.frame(
s = c(5, 15, 30),
e = c(10, 25, 40),
y = c(1, 1, 1)
)
ggplot(df, aes(xmin = s, xmax = e, ymin = y - 0.5, ymax = y + 0.5)) +
geom_rect(aes(), colour = "grey50")
df <- data.frame(
g = c(rep('gene1', 3), rep('gene2', 3))
s = c(5, 15, 30, 6, 8, 15),
e = c(10, 25, 40, 7, 10, 20),
y = c(1, 1, 1, 2, 2, 2)
)
ggplot(df, aes(xmin = s, xmax = e, ymin = y - 0.5, ymax = y + 0.5)) +
geom_rect(aes(), colour = "grey50")
df <- data.frame(
g = c(rep('gene1', 3), rep('gene2', 3)),
s = c(5, 15, 30, 6, 8, 15),
e = c(10, 25, 40, 7, 10, 20),
y = c(1, 1, 1, 2, 2, 2)
)
ggplot(df, aes(xmin = s, xmax = e, ymin = y - 0.5, ymax = y + 0.5)) +
geom_rect(aes(), colour = "grey50")
ggplot(df, aes(xmin = s, xmax = e, ymin = y - 0.3, ymax = y + 0.3)) +
geom_rect(aes(), colour = "grey50")
library(pheatmap)
cazy_files <- list.files('cazy', full.names = TRUE)
source('~/scripts/theme_kirsten.R')
library(pheatmap)
library(RColorBrewer)
library(tidyverse)
cazy <- lapply(cazy_files, function(c){
read_tsv(c) %>%
mutate(genome = sub(".txt", "", basename(c)))
}) %>% bind_rows() %>%
separate(HMMER, into = c('hmmer', 'startstop'), sep = "\\(", remove = FALSE) %>%
separate(startstop, into = c('start', 'stop'), sep = '-') %>%
mutate(stop = sub("\\)", "", stop)) %>%
mutate(HMMER = gsub('\\([0-9-]+\\)', "", HMMER)) %>%
select(-hmmer) %>%
rename(gene = `Gene ID`) %>%
gather(tool, cazy_id, -gene, -start, -stop, -`#ofTools`, -genome) %>%
group_by(gene) %>%
mutate(cazy_ids = paste(unique(cazy_id), collapse = ",")) %>%
select(-tool, -cazy_id, -`#ofTools`) %>%
unnest(cazy_id = strsplit(cazy_ids, ",")) %>%
unnest(cazy = strsplit(cazy_id, "\\+")) %>%
select(gene, start, stop, genome, cazy) %>%
distinct() %>%
mutate(cazy_base = sub("_.*$", "", cazy)) %>%
left_join(., fam_db, by = 'cazy_base') %>%
filter(cazy != 'N') %>%
group_by(genome, cazy_base) %>%
mutate(n_genes = as.numeric(length(unique(gene))))
fam_db <- read_tsv('CAZyDB.07312018.fam-activities.txt', comment = '#', col_names = c('cazy_base', 'cazy_description'))
setwd("~/Google Drive/Posters:Presentations/2019_Raper_Symposium/annotation")
card_file
cazy_files <- list.files('cazy', full.names = TRUE)
fam_db <- read_tsv('CAZyDB.07312018.fam-activities.txt', comment = '#', col_names = c('cazy_base', 'cazy_description'))
cazy <- lapply(cazy_files, function(c){
read_tsv(c) %>%
mutate(genome = sub(".txt", "", basename(c)))
}) %>% bind_rows() %>%
separate(HMMER, into = c('hmmer', 'startstop'), sep = "\\(", remove = FALSE) %>%
separate(startstop, into = c('start', 'stop'), sep = '-') %>%
mutate(stop = sub("\\)", "", stop)) %>%
mutate(HMMER = gsub('\\([0-9-]+\\)', "", HMMER)) %>%
select(-hmmer) %>%
rename(gene = `Gene ID`) %>%
gather(tool, cazy_id, -gene, -start, -stop, -`#ofTools`, -genome) %>%
group_by(gene) %>%
mutate(cazy_ids = paste(unique(cazy_id), collapse = ",")) %>%
select(-tool, -cazy_id, -`#ofTools`) %>%
unnest(cazy_id = strsplit(cazy_ids, ",")) %>%
unnest(cazy = strsplit(cazy_id, "\\+")) %>%
select(gene, start, stop, genome, cazy) %>%
distinct() %>%
mutate(cazy_base = sub("_.*$", "", cazy)) %>%
left_join(., fam_db, by = 'cazy_base') %>%
filter(cazy != 'N') %>%
group_by(genome, cazy_base) %>%
mutate(n_genes = as.numeric(length(unique(gene))))
head(cazy)
cazy %>% select(-start, -stop) %>% spread(genome, n_genes)
cazy %>% select(-start, -stop, -gene) %>% spread(genome, n_genes)
cazy %>% select(-start, -stop, -gene) %>% distinct() %>% spread(genome, n_genes)
cazy %>% select(-start, -stop, -gene) %>% distinct() %>% spread(genome, n_genes) %>% nrow()
c_sum <- cazy %>% select(-start, -stop, -gene) %>% distinct() %>% spread(genome, n_genes) %>% nrow()
c_heat <- c_sum %>% select(-cazy, -cazy_description)
c_sum <- cazy %>% select(-start, -stop, -gene) %>% distinct() %>% spread(genome, n_genes)
c_heat <- c_sum %>% select(-cazy, -cazy_description)
head(c_heat)
c_heat <- c_sum %>% select(-cazy, -cazy_description) %>% data.frame()
c_heat[is.na(c_heat)] <- 0
rownames(c_heat) <- c_heat$cazy_base
source('~/Google Drive/Posters:Presentations/2019_Raper_Symposium/annotation/make_annotation_fig.R', echo=TRUE)
c_heat <- c_sum %>% select(-cazy_base, -cazy_description) %>% data.frame()
c_sum <- cazy %>% select(-start, -stop, -gene) %>% distinct() %>% spread(genome, n_genes)
c_heat <- c_sum %>% select(-cazy_base, -cazy_description) %>% data.frame()
c_heat[is.na(c_heat)] <- 0
c_sum <- cazy %>% ungroup() %>% select(-start, -stop, -gene) %>% distinct() %>% spread(genome, n_genes)
c_heat <- c_sum %>% select(-cazy_base, -cazy_description) %>% data.frame()
c_heat[is.na(c_heat)] <- 0
rownames(c_heat) <- c_heat$cazy_base
rownames(c_heat) <- c_heat$cazy
c_heat$cazy <- NULL
head(c_heat)
c_sum <- cazy %>% ungroup() %>% select(-start, -stop, -gene) %>% distinct() %>% spread(cazy, n_genes)
c_heat <- c_sum %>% select(-cazy_base, -cazy_description) %>% data.frame()
c_heat[is.na(c_heat)] <- 0
rownames(c_heat) <- c_heat$genome
c_heat$genome <- NULL
head(c_sum)
head(c_heat)
c_sum <- cazy %>% ungroup() %>% select(-start, -stop, -gene) %>% distinct() %>% spread(genome, n_genes)
c_heat <- c_sum %>% select(-cazy_base, -cazy_description) %>% data.frame()
c_heat[is.na(c_heat)] <- 0
rownames(c_heat) <- c_heat$cazy
c_heat$cazy <- NULL
pheatmap(t(matrix(c_heat)),
color = c('grey87', 'black'),
cluster_rows = FALSE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10)
pheatmap(matrix(c_heat),
color = c('grey87', 'black'),
cluster_rows = FALSE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10)
c_sum <- cazy %>% ungroup() %>% select(-start, -stop, -gene) %>% distinct() %>% spread(genome, n_genes)
c_heat <- c_sum %>% select(-cazy_base, -cazy_description) %>% data.frame()
c_heat[is.na(c_heat)] <- 0
rownames(c_heat) <- c_heat$cazy
c_heat$cazy <- NULL
pheatmap(matrix(c_heat),
color = c('grey87', 'black'),
cluster_rows = FALSE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10)
head(c_heat)
matrix(c_heat)
as.matrix(c_heat),
as.matrix(c_heat)
pheatmap(as.matrix(c_heat),
pheatmap(as.matrix(c_heat),
color = c('grey87', 'black'),
cluster_rows = FALSE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10)
)
,
pheatmap(as.matrix(c_heat),
color = c('grey87', 'black'),
cluster_rows = FALSE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10)
pheatmap(as.matrix(c_heat),
color = c('grey87', 'black'),
cluster_rows = FALSE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
filename = 'cazy_heat.pdf')
pheatmap(as.matrix(c_heat),
cluster_rows = FALSE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
filename = 'cazy_heat.pdf')
pheatmap(as.matrix(c_heat),
cluster_rows = TRUE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
filename = 'cazy_heat.pdf')
colors <- colorRampPalette(brewer.pal(n = 7, name ="Blues"))(11)
colors
pheatmap(as.matrix(c_heat),
cluster_rows = TRUE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
filename = 'cazy_heat.pdf',
color = colors)
head(c_heat
)
rowSums(c_heat)
c_heat_f <- c_heat[which(rowSums(c_heat)/ncol(c_heat) > 10), ]
nrow(c_heat_f)
c_heat_f <- c_heat[which(rowSums(c_heat)/ncol(c_heat) > 9), ]
nrow(c_heat_f)
head(c_heat_f)
summary(c_heat)
c_heat_f <- c_heat[which(rowSums(c_heat) > 10), ]
nrow(c_heat_f)
colors <- colorRampPalette(brewer.pal(n = 7, name ="Blues"))(11)
pheatmap(as.matrix(c_heat),
cluster_rows = TRUE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
filename = 'cazy_heat.pdf',
color = colors)
c_heat_f <- c_heat[which(rowSums(c_heat) > 20), ]
nrow(c_heat_f)
colors <- colorRampPalette(brewer.pal(n = 7, name ="Blues"))(11)
pheatmap(as.matrix(c_heat),
cluster_rows = TRUE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
filename = 'cazy_heat.pdf',
color = colors)
colors <- colorRampPalette(brewer.pal(n = 7, name ="Blues"))(11)
pheatmap(as.matrix(c_heat_f),
cluster_rows = TRUE,
cluster_cols = FALSE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
filename = 'cazy_heat.pdf',
color = colors)
colors <- colorRampPalette(brewer.pal(n = 7, name ="Reds"))(11)
pheatmap(as.matrix(c_heat_f),
cluster_rows = TRUE,
cluster_cols = TRUE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
filename = 'cazy_heat.pdf',
color = colors)
pheatmap(as.matrix(c_heat),
cluster_rows = TRUE,
cluster_cols = TRUE,
border_color = "grey70",
cellwidth = 10,
cellheight = 10,
filename = 'cazy_heat.pdf',
color = colors)
head(cazy)
head(fam_db)
filter(fam_db, cazy_base == 'GH55')
filter(fam_db, cazy_base == 'GH28')
filter(fam_db, cazy_base == 'GH2')
filter(fam_db, cazy_base == 'GH13_25')
filter(fam_db, cazy_base == 'GH13')
filter(fam_db, cazy_base == 'AA2')
filter(fam_db, cazy_base == 'GT1')
filter(fam_db, cazy_base == 'GH71')
filter(fam_db, cazy_base == 'GH71')
filter(fam_db, cazy_base == 'GH32')
filter(fam_db, cazy_base == 'GH31')
filter(fam_db, cazy_base == 'CBM50')
filter(fam_db, cazy_base == 'GH71')
filter(fam_db, cazy_base == 'GH32')
filter(fam_db, cazy_base == 'GH31')
filter(fam_db, cazy_base == 'CBM50')
filter(fam_db, cazy_base == 'GH5')
filter(fam_db, cazy_base == 'CE10')
filter(fam_db, cazy_base == 'AA7')
filter(fam_db, cazy_base == 'GH18')
filter(fam_db, cazy_base == 'CE5')
head(c_heat)
pca_data <- prcomp(c_heat)
pca_rot <- data.frame(pca_data$rotation,
acc = rownames(pca_data$rotation)
) %>%
left_join(., metadata, by = 'acc') %>%
mutate(Agriculture = ifelse(is.na(Agriculture),
yes = 'Generalist',
no = Agriculture)) %>%
rename('Agriculture' = Agriculture)
colours <- c("Generalist" = "#808080",
"Coral" = "#CE3DD0",
"Higher" = "#2D71F6",
"Lower" = "#FFFEAB",
"Leafcutter" = "#377D22")
geom_text_data <- pca_rot %>%
filter(genus != 'Escovopsis')
head(pca_rot)
head(pca_data)
head(pca_data$rotation)
head(metadata)
head(metadata)$acc
metadata_t <- metadata %>% mutate(acc = sub("\\..*$", "", acc))
head(metadata_t)
head(metadata_t)$acc
pca_rot <- data.frame(pca_data$rotation,
acc = rownames(pca_data$rotation)
) %>%
left_join(., metadata, by = 'acc') %>%
mutate(Agriculture = ifelse(is.na(Agriculture),
yes = 'Generalist',
no = Agriculture)) %>%
rename('Agriculture' = Agriculture)
head(pca_rot)
pca_rot <- data.frame(pca_data$rotation,
acc = rownames(pca_data$rotation)
) %>%
left_join(., metadata_t, by = 'acc') %>%
mutate(Agriculture = ifelse(is.na(Agriculture),
yes = 'Generalist',
no = Agriculture)) %>%
rename('Agriculture' = Agriculture)
head(pca_rot)
colours <- c("Generalist" = "#808080",
"Coral" = "#CE3DD0",
"Higher" = "#2D71F6",
"Lower" = "#FFFEAB",
"Leafcutter" = "#377D22")
geom_text_data <- pca_rot %>%
filter(genus != 'Escovopsis')
ggplot(data = pca_rot, aes(x = PC1, y = PC2, label = pca_label)) +
geom_point(shape = 21, size = 4, aes(fill = Agriculture), stroke = 0.5, colour = 'black') +
#geom_point(shape = 21, colour = "black", fill = "white", size = 5, stroke = 5)
theme_classic() +
geom_text(data = geom_text_data, hjust = 1, vjust = 0, size = 3) +
scale_fill_manual(values = colours) +
scale_x_continuous(expand = c(0, 0.2)) +
ggsave('cazy_pca_12.pdf')
ggplot(data = pca_rot, aes(x = PC1, y = PC2)) +
geom_point(shape = 21, size = 4, aes(fill = Agriculture), stroke = 0.5, colour = 'black') +
#geom_point(shape = 21, colour = "black", fill = "white", size = 5, stroke = 5)
theme_classic() +
geom_text(data = geom_text_data, hjust = 1, vjust = 0, size = 3) +
scale_fill_manual(values = colours) +
scale_x_continuous(expand = c(0, 0.2)) +
ggsave('cazy_pca_12.pdf')
ggplot(data = pca_rot, aes(x = PC1, y = PC2)) +
geom_point(shape = 21, size = 4, aes(fill = Agriculture), stroke = 0.5, colour = 'black') +
#geom_point(shape = 21, colour = "black", fill = "white", size = 5, stroke = 5)
theme_classic() +
#geom_text(data = geom_text_data, hjust = 1, vjust = 0, size = 3) +
scale_fill_manual(values = colours) +
scale_x_continuous(expand = c(0, 0.2)) +
ggsave('cazy_pca_12.pdf')
glimpse(pca_data)
pca_data$sdev
ncol(pca_data$rotation)
?prcomp
summary(pca)
summary(pca_data)
summary(pca_data)$PC1
data.frame(summary(pca_data))
eigs <- pca_data$sdev^2
rbind(
SD = sqrt(eigs),
Proportion = eigs/sum(eigs),
Cumulative = cumsum(eigs)/sum(eigs))
pca_explained <- rbind(
SD = sqrt(eigs),
Proportion = eigs/sum(eigs),
Cumulative = cumsum(eigs)/sum(eigs))
pca_explained$1
pca_explained[,1]
pca_explained[,1]$Proportion
proportion = eigs/sum(eigs)
proportion
cumulative = cumsum(eigs)/sum(eigs)
cumulative
proportion = as.numeric(eigs/sum(eigs))
proportion
proportion = (eigs/sum(eigs))*100
proportion
head(pca_data$rotation)
pca_data
pca_data
pca_data <- prcomp(t(c_heat))
pca_rot <- data.frame(pca_data$rotation,
acc = rownames(pca_data$rotation)
) %>%
left_join(., metadata_t, by = 'acc') %>%
mutate(Agriculture = ifelse(is.na(Agriculture),
yes = 'Generalist',
no = Agriculture)) %>%
rename('Agriculture' = Agriculture)
head(pca_rot)
eigs <- pca_data$sdev^2
proportion = (eigs/sum(eigs))*100
cumulative = cumsum(eigs)/sum(eigs)
proportion
ggplot(data = pca_rot, aes(x = PC1, y = PC2)) +
geom_point(shape = 21, size = 4, aes(fill = Agriculture), stroke = 0.5, colour = 'black') +
#geom_point(shape = 21, colour = "black", fill = "white", size = 5, stroke = 5)
theme_classic() +
#geom_text(data = geom_text_data, hjust = 1, vjust = 0, size = 3) +
scale_fill_manual(values = colours) +
scale_x_continuous(expand = c(0, 0.2)) +
ggsave('cazy_pca_12.pdf')
ggplot(data = pca_rot, aes(x = PC1, y = PC2)) +
geom_point(shape = 21, size = 4, aes(fill = Agriculture), stroke = 0.5, colour = 'black') +
#geom_point(shape = 21, colour = "black", fill = "white", size = 5, stroke = 5)
theme_classic() +
#geom_text(data = geom_text_data, hjust = 1, vjust = 0, size = 3) +
scale_fill_manual(values = colours) +
scale_x_continuous(expand = c(0, 0.2)) +
ggsave('cazy_pca2_12.pdf')
glimpse(pca_data)
head(pca_data$rotation)
pca_data <- prcomp(c_heat)
metadata_t <- metadata %>% mutate(acc = sub("\\..*$", "", acc))
pca_rot <- data.frame(pca_data$rotation,
acc = rownames(pca_data$rotation)
) %>%
left_join(., metadata_t, by = 'acc') %>%
mutate(Agriculture = ifelse(is.na(Agriculture),
yes = 'Generalist',
no = Agriculture)) %>%
rename('Agriculture' = Agriculture)
colours <- c("Generalist" = "#808080",
"Coral" = "#CE3DD0",
"Higher" = "#2D71F6",
"Lower" = "#FFFEAB",
"Leafcutter" = "#377D22")
head(pca_data$rotation)
glimpse(pca_data)
glimpse(pca_data$x)
head(pca_data$x)
?prcomp
autoplot(pca_data,
loadings = TRUE, loadings.colour = 'blue',
loadings.label = TRUE, loadings.label.size = 3)
autoplot(pca_data, data = c_heat,
loadings = TRUE, loadings.colour = 'blue',
loadings.label = TRUE, loadings.label.size = 3)
## bigscape PCA
library(ggfortify)
install.packages('ggfortify')
## bigscape PCA
library(ggfortify)
autoplot(pca_data, data = c_heat,
loadings = TRUE, loadings.colour = 'blue',
loadings.label = TRUE, loadings.label.size = 3)
autoplot(pca_data, data = c_heat,
loadings = TRUE, loadings.colour = 'blue',
loadings.label = TRUE, loadings.label.size = 3) + ggsave('test.pdf')
